<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سیستم پیشرفته تحلیل نقاط جغرافیایی</title>
    <link rel="stylesheet" href="https://openlayers.org/en/v6.14.1/css/ol.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --danger-color: #e74c3c;
            --dark-color: #2c3e50;
            --light-color: #ecf0f1;
        }
        
        body {
            font-family: 'Yekan', Tahoma, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        
        #map-container {
            display: flex;
            flex-direction: row;
            height: 100vh;
            width: 100%;
        }
        
        #map {
            flex: 1;
            height: 100%;
            background-color: #e0e0e0;
            order: 2;
        }
        
        #sidebar {
            width: 350px;
            min-width: 300px;
            height: 100%;
            display: flex;
            flex-direction: column;
            background-color: white;
            border-left: 1px solid #ddd;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            order: 1;
            overflow: hidden;
        }
        
        #header {
            background-color: var(--dark-color);
            color: white;
            padding: 15px;
            text-align: center;
            position: relative;
            flex-shrink: 0;
        }
        
        #controls {
            padding: 15px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: auto;
        }
        
        .control-section {
            margin-bottom: 15px;
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .section-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-title i {
            font-size: 16px;
        }
        
        #group-controls {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        #current-group {
            font-weight: bold;
            color: var(--dark-color);
            margin-bottom: 15px;
            padding: 8px;
            background-color: var(--light-color);
            border-radius: 5px;
            text-align: center;
        }
        
        #point-list-container {
            flex-grow: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        #point-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        #point-list {
            flex-grow: 1;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: white;
        }
        
        .point-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
            font-size: 13px;
            transition: background-color 0.2s;
        }
        
        .point-item:hover {
            background-color: #f9f9f9;
        }
        
        .point-info {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            min-width: 0;
        }
        
        .point-name {
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .point-details {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #666;
            margin-top: 3px;
        }
        
        .point-group {
            background-color: var(--light-color);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 11px;
            color: var(--dark-color);
        }
        
        .point-actions {
            display: flex;
            gap: 5px;
        }
        
        .point-actions button {
            background: none;
            border: none;
            cursor: pointer;
            color: #666;
            font-size: 14px;
            transition: color 0.2s;
        }
        
        .point-actions button:hover {
            color: var(--primary-color);
        }
        
        .point-actions .delete-btn:hover {
            color: var(--danger-color);
        }
        
        input, select, button {
            font-family: 'Yekan', Tahoma, sans-serif;
        }
        
        #group-input {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 13px;
        }
        
        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #27ae60;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-sm {
            padding: 5px 8px;
            font-size: 12px;
        }
        
        .slider-container {
            margin: 10px 0;
        }
        
        .slider-container label {
            display: block;
            margin-bottom: 5px;
            font-size: 13px;
        }
        
        .slider {
            width: 100%;
        }
        
        .toggle-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }
        
        .toggle-btn {
            width: 100%;
            justify-content: center;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        
        .stat-box {
            background-color: var(--light-color);
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-size: 12px;
        }
        
        .stat-value {
            font-weight: bold;
            font-size: 14px;
            color: var(--dark-color);
            margin-top: 3px;
        }
        
        #export-section {
            position: sticky;
            bottom: 0;
            background: white;
            padding: 15px;
            border-top: 1px solid #ddd;
            margin-top: auto;
        }
        
        #export-btn {
            width: 100%;
        }
        
        #status {
            margin-top: 10px;
            font-size: 12px;
            color: #7f8c8d;
            text-align: center;
        }
        
        .empty-state {
            text-align: center;
            padding: 20px;
            color: #777;
            font-size: 13px;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            #map-container {
                flex-direction: column;
            }
            
            #sidebar {
                width: 100%;
                height: auto;
                max-height: 50vh;
                order: 2;
                border-left: none;
                border-top: 1px solid #ddd;
            }
            
            #map {
                height: 50vh;
                order: 1;
            }
            
            #export-section {
                position: static;
            }
        }
    </style>
</head>
<body>
    <div id="map-container">
        <div id="map"></div>
        <div id="sidebar">
            <div id="header">
                <h3><i class="fas fa-map-marked-alt"></i> سیستم تحلیل نقاط جغرافیایی</h3>
            </div>
            <div id="controls">
                <div class="control-section">
                    <div class="section-title"><i class="fas fa-layer-group"></i> مدیریت گروه‌ها</div>
                    <div id="group-controls">
                        <input type="text" id="group-input" placeholder="نام گروه جدید">
                        <button id="set-group-btn" class="btn btn-primary btn-sm"><i class="fas fa-check"></i> اعمال</button>
                    </div>
                    <div id="current-group">گروه فعلی: <span id="active-group-name">بدون گروه</span></div>
                </div>
             
                <div class="control-section">
                    <div class="section-title"><i class="fas fa-fire"></i> تنظیمات Heatmap</div>
                    <div class="slider-container">
                        <label for="heatmap-intensity">شدت نمایش:</label>
                        <input type="range" id="heatmap-intensity" class="slider" min="5" max="30" value="15">
                    </div>
                    <div class="slider-container">
                        <label for="heatmap-opacity">شفافیت:</label>
                        <input type="range" id="heatmap-opacity" class="slider" min="1" max="10" value="7">
                    </div>
                    <div class="toggle-container">
                        <button id="toggle-heatmap" class="btn btn-secondary toggle-btn">
                            <i class="fas fa-eye"></i> نمایش/پنهان Heatmap
                        </button>
                    </div>
                </div>
                
                <div class="control-section">
                    <div class="section-title"><i class="fas fa-chart-pie"></i> آمار و تحلیل</div>
                    <div class="stats-container">
                        <div class="stat-box">
                            تعداد نقاط
                            <div class="stat-value" id="total-points">0</div>
                        </div>
                        <div class="stat-box">
                            گروه‌های فعال
                            <div class="stat-value" id="total-groups">0</div>
                        </div>
                    </div>
                    <button id="analyze-btn" class="btn btn-secondary" style="margin-top: 10px; width: 100%;">
                        <i class="fas fa-chart-bar"></i> تحلیل تراکم نقاط
                    </button>
                </div>
            
                <div class="control-section" style="flex-grow: 1; display: flex; flex-direction: column;">
                    <div class="section-title"><i class="fas fa-list"></i> لیست نقاط</div>
                    <div id="point-list-container">
                        <div id="point-list-header">
                            <span>نقاط ثبت شده</span>
                            <button id="clear-all-btn" class="btn btn-danger btn-sm">
                                <i class="fas fa-trash"></i> حذف همه
                            </button>
                        </div>
                        <div id="point-list"></div>
                    </div>
                </div>
                
                <div id="export-section">
                    <button id="export-btn" class="btn btn-primary">
                        <i class="fas fa-download"></i> ذخیره اطلاعات (CSV)
                    </button>
                    <div id="status">تعداد نقاط: 0</div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://openlayers.org/en/v6.14.1/build/ol.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ol-ext@3.1.14/dist/ol-ext.js"></script>
    <script>
        // آرایه برای ذخیره نقاط
        let points = [];
        let currentGroup = "بدون گروه";
        let heatmapVisible = true;
        let circlesVisible = true;
        let clustersVisible = false;
        let uniqueGroups = new Set();
        
        // ایجاد نقشه
        const map = new ol.Map({
            target: 'map',
            layers: [
                new ol.layer.Tile({
                    source: new ol.source.OSM({
                        url: 'https://{a-c}.tile.openstreetmap.org/{z}/{x}/{y}.png'
                    })
                })
            ],
            view: new ol.View({
                center: ol.proj.fromLonLat([54.432934, 36.841671]), // مرکز روی تهران
                zoom: 10
            })
        });

        // لایه برای نقاط
        const vectorSource = new ol.source.Vector();
        const vectorLayer = new ol.layer.Vector({
            source: vectorSource,
            style: function(feature) {
                const group = feature.get('group');
                const color = getGroupColor(group);
                
                return new ol.style.Style({
                    image: new ol.style.Circle({
                        radius: 6,
                        fill: new ol.style.Fill({color: color}),
                        stroke: new ol.style.Stroke({
                            color: 'white', width: 2
                        })
                    }),
                    text: new ol.style.Text({
                        text: feature.get('name') + (group !== "بدون گروه" ? ` (${group})` : ''),
                        offsetY: -15,
                        font: '12px Yekan',
                        fill: new ol.style.Fill({color: '#333'}),
                        stroke: new ol.style.Stroke({
                            color: 'white', width: 3
                        })
                    })
                });
            }
        });
        map.addLayer(vectorLayer);



        // لایه خوشه‌بندی
        const clusterSource = new ol.source.Cluster({
            distance: 40,
            source: vectorSource
        });
        
        const clusterLayer = new ol.layer.Vector({
            source: clusterSource,
            style: function(feature) {
                const size = feature.get('features').length;
                if (size > 1) {
                    return new ol.style.Style({
                        image: new ol.style.Circle({
                            radius: 15,
                            fill: new ol.style.Fill({
                                color: 'rgba(255, 153, 0, 0.7)'
                            }),
                            stroke: new ol.style.Stroke({
                                color: 'rgba(255, 204, 0, 0.9)',
                                width: 2
                            })
                        }),
                        text: new ol.style.Text({
                            text: size.toString(),
                            fill: new ol.style.Fill({
                                color: '#fff'
                            }),
                            font: 'bold 12px Yekan'
                        })
                    });
                } else {
                    const originalFeature = feature.get('features')[0];
                    const group = originalFeature.get('group');
                    const color = getGroupColor(group);
                    
                    return new ol.style.Style({
                        image: new ol.style.Circle({
                            radius: 6,
                            fill: new ol.style.Fill({color: color}),
                            stroke: new ol.style.Stroke({
                                color: 'white', width: 2
                            })
                        }),
                        text: new ol.style.Text({
                            text: originalFeature.get('name'),
                            offsetY: -15,
                            font: '12px Yekan',
                            fill: new ol.style.Fill({color: '#333'}),
                            stroke: new ol.style.Stroke({
                                color: 'white', width: 3
                            })
                        })
                    });
                }
            }
        });
        clusterLayer.setVisible(false);
        map.addLayer(clusterLayer);

        // لایه برای دایره‌های 300 متری
        const circlesSource = new ol.source.Vector();
        const circlesLayer = new ol.layer.Vector({
            source: circlesSource,
            style: function(feature) {
                const group = feature.get('group');
                const color = getGroupColor(group);
                
                return new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: hexToRgba(color, 0.7),
                        width: 2
                    }),
                    fill: new ol.style.Fill({
                        color: hexToRgba(color, 0.1)
                    })
                });
            }
        });
        circlesLayer.setVisible(false);
        map.addLayer(circlesLayer);

        // لایه برای نمایش محدوده‌های تراکم
        const densityLayer = new ol.layer.Vector({
            source: new ol.source.Vector(),
            style: new ol.style.Style({
                fill: new ol.style.Fill({
                    color: 'rgba(0, 0, 255, 0.3)'
                }),
                stroke: new ol.style.Stroke({
                    color: 'rgba(0, 0, 255, 0.7)',
                    width: 2
                })
            })
        });
        densityLayer.setVisible(false);
        map.addLayer(densityLayer);

        // تابع برای تبدیل رنگ HEX به RGBA
        function hexToRgba(hex, alpha) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        // تابع برای اختصاص رنگ به گروه‌ها
        function getGroupColor(group) {
            if (group === "بدون گروه") return '#e74c3c';
            
            const groupColors = [
                '#3498db', '#2ecc71', '#9b59b6', '#f1c40f', 
                '#1abc9c', '#d35400', '#34495e', '#16a085',
                '#c0392b', '#8e44ad', '#27ae60', '#2980b9'
            ];
            
            const groups = Array.from(uniqueGroups);
            const index = groups.indexOf(group);
            return groupColors[index % groupColors.length];
        }

        // تعیین گروه فعلی
        document.getElementById('set-group-btn').addEventListener('click', function() {
            const groupName = document.getElementById('group-input').value.trim();
            if (groupName) {
                currentGroup = groupName;
                uniqueGroups.add(currentGroup);
                document.getElementById('active-group-name').textContent = currentGroup;
                document.getElementById('group-input').value = '';
                updateGroupFilter();
                updateStats();
            }
        });

        // کنترل Heatmap
        document.getElementById('heatmap-intensity').addEventListener('input', function() {
            heatmapLayer.setRadius(parseInt(this.value));
        });

        document.getElementById('heatmap-opacity').addEventListener('input', function() {
            heatmapLayer.setOpacity(parseInt(this.value) / 10);
        });

        // نمایش/پنهان Heatmap
        document.getElementById('toggle-heatmap').addEventListener('click', function() {
            heatmapVisible = !heatmapVisible;
            heatmapLayer.setVisible(heatmapVisible);
            this.innerHTML = heatmapVisible ? 
                '<i class="fas fa-eye-slash"></i> پنهان Heatmap' : 
                '<i class="fas fa-eye"></i> نمایش Heatmap';
        });

        // تحلیل تراکم نقاط
        document.getElementById('analyze-btn').addEventListener('click', function() {
            if (points.length === 0) {
                alert('هیچ نقطه‌ای برای تحلیل وجود ندارد');
                return;
            }
            
            // تغییر وضعیت نمایش دایره‌ها
            circlesVisible = !circlesVisible;
            circlesLayer.setVisible(circlesVisible);
            
            // تغییر وضعیت خوشه‌بندی
            clustersVisible = !clustersVisible;
            clusterLayer.setVisible(clustersVisible);
            vectorLayer.setVisible(!clustersVisible);
            
            // تحلیل تراکم
            if (circlesVisible) {
                analyzeDensity();
            }
            
            this.innerHTML = circlesVisible ? 
                '<i class="fas fa-chart-bar"></i> پنهان تحلیل' : 
                '<i class="fas fa-chart-bar"></i> تحلیل تراکم نقاط';
        });

        // تحلیل تراکم نقاط
        function analyzeDensity() {
            const densitySource = densityLayer.getSource();
            densitySource.clear();
            
            if (points.length < 2) return;
            
            // ایجاد محدوده‌های تراکم (مثال ساده)
            const extent = vectorSource.getExtent();
            if (!extent) return;
            
            const gridSize = 10; // تعداد تقسیم‌بندی‌ها در هر جهت
            const gridWidth = (extent[2] - extent[0]) / gridSize;
            const gridHeight = (extent[3] - extent[1]) / gridSize;
            
            for (let x = 0; x < gridSize; x++) {
                for (let y = 0; y < gridSize; y++) {
                    const minX = extent[0] + x * gridWidth;
                    const minY = extent[1] + y * gridHeight;
                    const maxX = minX + gridWidth;
                    const maxY = minY + gridHeight;
                    
                    const box = new ol.geom.Polygon.fromExtent([minX, minY, maxX, maxY]);
                    const featuresInBox = vectorSource.getFeaturesInExtent(box.getExtent());
                    
                    if (featuresInBox.length > 0) {
                        const densityFeature = new ol.Feature({
                            geometry: box,
                            count: featuresInBox.length
                        });
                        
                        // تنظیم استایل بر اساس تراکم
                        const density = featuresInBox.length / (points.length / 20);
                        const style = new ol.style.Style({
                            fill: new ol.style.Fill({
                                color: `rgba(255, 0, 0, ${Math.min(0.3, density * 0.1)})`
                            }),
                            stroke: new ol.style.Stroke({
                                color: `rgba(255, 0, 0, ${Math.min(0.7, density * 0.3)})`,
                                width: 1
                            })
                        });
                        
                        densityFeature.setStyle(style);
                        densitySource.addFeature(densityFeature);
                    }
                }
            }
            
            densityLayer.setVisible(true);
        }

        // حذف همه نقاط
        document.getElementById('clear-all-btn').addEventListener('click', function() {
            if (points.length === 0 || confirm('آیا از حذف تمام نقاط اطمینان دارید؟')) {
                points = [];
                vectorSource.clear();
                heatmapSource.clear();
                circlesSource.clear();
                densityLayer.getSource().clear();
                uniqueGroups.clear();
                updatePointList();
                updateGroupFilter();
                updateStats();
            }
        });

        // افزودن نقطه با کلیک
        map.on('click', function(evt) {
            const coordinate = evt.coordinate;
            const lonLat = ol.proj.toLonLat(coordinate);
            
            const pointName = prompt('نام نقطه را وارد کنید:', `نقطه ${points.length + 1}`);
            if (!pointName) return;
            
            // ذخیره نقطه
            const newPoint = {
                id: Date.now(),
                name: pointName,
                group: currentGroup,
                lon: lonLat[0].toFixed(6),
                lat: lonLat[1].toFixed(6),
                timestamp: new Date().toISOString()
            };
            points.push(newPoint);
            uniqueGroups.add(currentGroup);
            
            // نمایش نقطه روی نقشه
            addPointToMap(newPoint);
            
            // به روز رسانی لیست
            updatePointList();
            updateGroupFilter();
            updateStats();
        });

        // تابع برای افزودن نقطه به نقشه
        function addPointToMap(point) {
            const coordinate = ol.proj.fromLonLat([parseFloat(point.lon), parseFloat(point.lat)]);
            const color = getGroupColor(point.group);
            
            // ایجاد مارکر نقطه
            const marker = new ol.Feature({
                geometry: new ol.geom.Point(coordinate),
                name: point.name,
                group: point.group
            });
            
            marker.set('pointId', point.id);
            vectorSource.addFeature(marker);
            
            // اضافه کردن به Heatmap
            const heatmapPoint = new ol.Feature({
                geometry: new ol.geom.Point(coordinate),
                weight: 0.5
            });
            heatmapSource.addFeature(heatmapPoint);
            
            // ایجاد دایره 300 متری
            const circle = new ol.Feature({
                geometry: new ol.geom.Circle(
                    coordinate,
                    300 // شعاع 300 متر
                ),
                group: point.group
            });
            circlesSource.addFeature(circle);
        }

        // به روز رسانی لیست نقاط
        function updatePointList() {
            const listElement = document.getElementById('point-list');
            listElement.innerHTML = '';
            
            if (points.length === 0) {
                const emptyState = document.createElement('div');
                emptyState.className = 'empty-state';
                emptyState.textContent = 'هنوز نقطه‌ای اضافه نشده است';
                listElement.appendChild(emptyState);
                return;
            }
            
            points.forEach(point => {
                const item = document.createElement('div');
                item.className = 'point-item new-point';
                item.innerHTML = `
                    <div class="point-info">
                        <div class="point-name">${point.name}</div>
                        <div class="point-details">
                            <span>${point.lon}, ${point.lat}</span>
                            ${point.group !== "بدون گروه" ? `<span class="point-group">${point.group}</span>` : ''}
                        </div>
                    </div>
                    <div class="point-actions">
                        <button class="zoom-btn" onclick="zoomToPoint(${point.id})" title="بزرگنمایی">
                            <i class="fas fa-search-plus"></i>
                        </button>
                        <button class="delete-btn" onclick="removePoint(${point.id})" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                listElement.appendChild(item);
                
                // حذف انیمیشن پس از اجرا
                setTimeout(() => {
                    item.classList.remove('new-point');
                }, 300);
            });
            
            document.getElementById('status').textContent = `تعداد نقاط: ${points.length}`;
            document.getElementById('total-points').textContent = points.length;
        }

        // بزرگنمایی به نقطه
        window.zoomToPoint = function(pointId) {
            const point = points.find(p => p.id === pointId);
            if (point) {
                const coordinate = ol.proj.fromLonLat([parseFloat(point.lon), parseFloat(point.lat)]);
                map.getView().animate({
                    center: coordinate,
                    zoom: 15,
                    duration: 500
                });
            }
        };

        // حذف نقطه
        window.removePoint = function(pointId) {
            if (!confirm('آیا از حذف این نقطه اطمینان دارید؟')) return;
            
            // حذف از آرایه
            points = points.filter(p => p.id !== pointId);
            
            // به روز رسانی گروه‌های منحصر به فرد
            updateUniqueGroups();
            
            // حذف از نقشه
            const featureToRemove = vectorSource.getFeatures().find(f => f.get('pointId') === pointId);
            if (featureToRemove) {
                vectorSource.removeFeature(featureToRemove);
            }
            
            // حذف از Heatmap و بازسازی
            heatmapSource.clear();
            points.forEach(p => {
                const heatmapPoint = new ol.Feature({
                    geometry: new ol.geom.Point(ol.proj.fromLonLat([parseFloat(p.lon), parseFloat(p.lat)])),
                    weight: 0.5
                });
                heatmapSource.addFeature(heatmapPoint);
            });
            
            // حذف و بازسازی دایره‌ها
            circlesSource.clear();
            points.forEach(p => {
                const circle = new ol.Feature({
                    geometry: new ol.geom.Circle(
                        ol.proj.fromLonLat([parseFloat(p.lon), parseFloat(p.lat)]),
                        300
                    ),
                    group: p.group
                });
                circlesSource.addFeature(circle);
            });
            
            // به روز رسانی لیست و آمار
            updatePointList();
            updateGroupFilter();
            updateStats();
        };

        // به روز رسانی فیلتر گروه‌ها
        function updateGroupFilter() {
            const filterSelect = document.getElementById('filter-group');
            
            // حفظ مقدار فعلی
            const currentValue = filterSelect.value;
            
            // پاکسازی گزینه‌ها
            filterSelect.innerHTML = '';
            
            // افزودن گزینه همه
            const allOption = document.createElement('option');
            allOption.value = 'all';
            allOption.textContent = 'همه گروه‌ها';
            filterSelect.appendChild(allOption);
            
            // افزودن گروه‌های منحصر به فرد
            Array.from(uniqueGroups).sort().forEach(group => {
                if (group !== "بدون گروه") {
                    const option = document.createElement('option');
                    option.value = group;
                    option.textContent = group;
                    filterSelect.appendChild(option);
                }
            });
            
            // افزودن گزینه بدون گروه اگر وجود دارد
            if (points.some(p => p.group === "بدون گروه")) {
                const noneOption = document.createElement('option');
                noneOption.value = "بدون گروه";
                noneOption.textContent = "بدون گروه";
                filterSelect.appendChild(noneOption);
            }
            
            // بازگرداندن مقدار قبلی اگر هنوز وجود دارد
            if (Array.from(filterSelect.options).some(opt => opt.value === currentValue)) {
                filterSelect.value = currentValue;
            }
        }

        // به روز رسانی گروه‌های منحصر به فرد
        function updateUniqueGroups() {
            uniqueGroups = new Set(points.map(p => p.group));
        }

        // به روز رسانی آمار
        function updateStats() {
            document.getElementById('total-points').textContent = points.length;
            document.getElementById('total-groups').textContent = uniqueGroups.size;
        }

        // ذخیره به CSV
        document.getElementById('export-btn').addEventListener('click', function() {
            if (points.length === 0) {
                alert('هنوز هیچ نقطه‌ای اضافه نشده است');
                return;
            }
            
            let csvContent = "نام,گروه,طول جغرافیایی,عرض جغرافیایی,تاریخ ثبت\n";
            points.forEach(point => {
                const date = new Date(point.timestamp || Date.now());
                const dateStr = date.toLocaleDateString('fa-IR');
                const timeStr = date.toLocaleTimeString('fa-IR');
                
                csvContent += `"${point.name}","${point.group}",${point.lon},${point.lat},"${dateStr} ${timeStr}"\n`;
            });
            
            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `نقاط_جغرافیایی_${new Date().toLocaleDateString('fa-IR')}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // نمایش پیام موفقیت
            alert(`فایل CSV با ${points.length} نقطه با موفقیت ذخیره شد`);
        });

        // نمایش پیام وقتی نقشه لود شد
        map.on('loadend', function() {
            document.getElementById('status').textContent = 'نقشه آماده است. روی نقشه کلیک کنید تا نقطه اضافه شود.';
        });

        // مقداردهی اولیه
        updateStats();
    </script>
</body>
</html>
